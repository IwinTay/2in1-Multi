<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Document Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF.js Library -->
    <script src="https://mozilla.github.io/pdf.js/build/pdf.mjs" type="module"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #upload-box.dragover {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
        [contenteditable]:focus {
            outline: 2px solid #4f46e5;
            background-color: #eef2ff;
        }
        .hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .highlight-warning {
            background-color: #fef9c3; /* yellow-100 */
        }
        .engine-btn {
            transition: all 0.2s ease-in-out;
        }
        .engine-btn.active {
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
        }
        .engine-btn:not(.active) {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        #table-container, #menu-table-container {
             overflow-x: auto;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">The Document Extractor</h1>
            <p class="text-gray-600 mt-2">Select an engine, then upload documents to extract structured data.</p>
        </header>

        <!-- Engine Selector -->
        <div class="mb-8 flex justify-center">
            <div class="inline-flex rounded-lg shadow-sm">
                <button id="menu-engine-btn" type="button" class="engine-btn active px-6 py-3 text-sm font-medium rounded-l-lg">Menu Engine</button>
                <button id="invoice-engine-btn" type="button" class="engine-btn px-6 py-3 text-sm font-medium rounded-r-lg">Invoice Engine</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left Panel: Upload & History -->
            <div class="lg:col-span-3 space-y-8">
                <div class="bg-white p-6 rounded-xl shadow-md h-full">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">1. Upload Files</h2>
                    <input type="file" id="file-input" accept=".pdf,.jpg,.jpeg,.png" class="hidden" multiple>
                    <label for="file-input" id="upload-box" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                        <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h5l4 4v5a4 4 0 01-4 4H7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 17.657L13.414 21.9a2 2 0 01-2.827 0L7 17.657M10 14l2-2m0 0l2-2m-2 2v4"></path></svg>
                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag & drop</p>
                        <p class="text-xs text-gray-500">PDF, JPG, PNG</p>
                    </label>
                    <div id="status" class="mt-4 text-sm text-center"></div>
                    <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-2 hidden">
                        <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Verify, Edit & Export -->
            <div class="lg:col-span-9">
                <div class="bg-white p-6 rounded-xl shadow-md h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900">2. Verify & Edit Data</h2>
                        <div class="flex items-center space-x-2">
                            <span id="currency-display" class="text-sm font-semibold text-gray-500 bg-gray-100 px-2 py-1 rounded-md hidden"></span>
                            <button id="clear-list-btn" class="text-sm bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600 disabled:bg-gray-300" disabled>Clear</button>
                        </div>
                    </div>

                    <!-- Menu Engine View -->
                    <div id="menu-view">
                        <div id="menu-table-container" class="overflow-auto max-h-[60vh] flex-grow">
                            <table class="min-w-full">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="p-2 w-6"></th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase w-10">#</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Item Name</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Item Price</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Item Category</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cuisine Type</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Variant Name</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Variant Price</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">SKU Code</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Variant SKU</th>
                                    </tr>
                                </thead>
                                <tbody id="menu-data-table" class="divide-y divide-gray-200">
                                    <tr><td colspan="11" class="p-4 text-center text-gray-500">Upload a file to begin.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Invoice Engine View -->
                    <div id="invoice-view" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6 p-4 border rounded-lg bg-gray-50">
                            <div><label class="block text-sm font-medium text-gray-700">Invoice #</label><div id="invoice-number" contenteditable="true" class="mt-1 p-2 border border-gray-300 rounded-md"></div></div>
                            <div><label class="block text-sm font-medium text-gray-700">Date</label><div id="invoice-date" contenteditable="true" class="mt-1 p-2 border border-gray-300 rounded-md"></div></div>
                            <div><label class="block text-sm font-medium text-gray-700">Due Date</label><div id="invoice-due-date" contenteditable="true" class="mt-1 p-2 border border-gray-300 rounded-md"></div></div>
                            <div><label class="block text-sm font-medium text-gray-700">Pay Date</label><div id="invoice-pay-date" contenteditable="true" class="mt-1 p-2 border border-gray-300 rounded-md"></div></div>
                            <div><label class="block text-sm font-medium text-gray-700">Vendor</label><div id="invoice-vendor" contenteditable="true" class="mt-1 p-2 border border-gray-300 rounded-md"></div></div>
                        </div>
                        <div id="invoice-table-container" class="overflow-auto max-h-[45vh] flex-grow">
                             <h3 class="text-lg font-semibold text-gray-800 mb-2">Line Items</h3>
                             <table class="min-w-full">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Barcode</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Qty</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cost Price</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Gross Amount</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tax Code</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                                    </tr>
                                </thead>
                                <tbody id="invoice-data-table" class="divide-y divide-gray-200">
                                    <!-- Invoice line items will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                         <div class="grid grid-cols-3 gap-4 mt-4 pt-4 border-t">
                            <div></div>
                            <div class="col-span-2 space-y-2 text-right">
                                <div class="flex justify-between"><span class="font-medium">Subtotal:</span><span id="invoice-subtotal"></span></div>
                                <div class="flex justify-between"><span class="font-medium">Tax:</span><span id="invoice-tax"></span></div>
                                <div class="flex justify-between font-bold text-lg"><span class="">Grand Total:</span><span id="invoice-total"></span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Export Panel -->
        <div class="mt-8">
            <div class="bg-white p-6 rounded-xl shadow-md">
                 <h2 class="text-2xl font-bold text-gray-900 mb-4">3. Export</h2>
                 <p class="text-sm text-gray-600 mb-4">Once you've verified the data, click the button below to download your cleaned data as a CSV file.</p>
                 <button id="export-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 disabled:bg-gray-300 text-lg" disabled>Export to CSV</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // --- PDF.js Setup ---
        const { pdfjsLib } = globalThis;
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://mozilla.github.io/pdf.js/build/pdf.worker.mjs`;

        // --- State Management ---
        let currentMode = 'menu'; // 'menu' or 'invoice'
        let extractedData = {}; // Will hold menu items or invoice data

        // --- DOM References ---
        const dom = {
            uploadBox: document.getElementById('upload-box'),
            fileInput: document.getElementById('file-input'),
            statusEl: document.getElementById('status'),
            exportBtn: document.getElementById('export-btn'),
            clearListBtn: document.getElementById('clear-list-btn'),
            progressBarContainer: document.getElementById('progress-bar-container'),
            progressBar: document.getElementById('progress-bar'),
            currencyDisplay: document.getElementById('currency-display'),
            menuEngineBtn: document.getElementById('menu-engine-btn'),
            invoiceEngineBtn: document.getElementById('invoice-engine-btn'),
            menuView: document.getElementById('menu-view'),
            invoiceView: document.getElementById('invoice-view'),
            menuDataTable: document.getElementById('menu-data-table'),
            invoiceDataTable: document.getElementById('invoice-data-table'),
            invoiceNumber: document.getElementById('invoice-number'),
            invoiceDate: document.getElementById('invoice-date'),
            invoiceDueDate: document.getElementById('invoice-due-date'),
            invoicePayDate: document.getElementById('invoice-pay-date'),
            invoiceVendor: document.getElementById('invoice-vendor'),
            invoiceSubtotal: document.getElementById('invoice-subtotal'),
            invoiceTax: document.getElementById('invoice-tax'),
            invoiceTotal: document.getElementById('invoice-total'),
        };

        // --- Engine Switching Logic ---
        dom.menuEngineBtn.addEventListener('click', () => switchEngine('menu'));
        dom.invoiceEngineBtn.addEventListener('click', () => switchEngine('invoice'));

        function switchEngine(mode) {
            currentMode = mode;
            if (mode === 'menu') {
                dom.menuEngineBtn.classList.add('active');
                dom.invoiceEngineBtn.classList.remove('active');
                dom.menuView.classList.remove('hidden');
                dom.invoiceView.classList.add('hidden');
            } else {
                dom.invoiceEngineBtn.classList.add('active');
                dom.menuEngineBtn.classList.remove('active');
                dom.invoiceView.classList.remove('hidden');
                dom.menuView.classList.add('hidden');
            }
            resetUI(); // Clear the view when switching engines
        }

        // --- File Upload Handling ---
        dom.fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        dom.uploadBox.addEventListener('dragover', (e) => { e.preventDefault(); dom.uploadBox.classList.add('dragover'); });
        dom.uploadBox.addEventListener('dragleave', () => dom.uploadBox.classList.remove('dragover'));
        dom.uploadBox.addEventListener('drop', (e) => { e.preventDefault(); dom.uploadBox.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });
        
        async function handleFile(file) {
            if (!file) return;
            
            resetUI();
            
            if (file.type.startsWith('image/')) {
                await processWithAI(file);
            } else if (file.type === 'application/pdf') {
                await processWithAI(file);
            } else {
                handleError('Unsupported file type.');
            }
        }
        
        function resetUI() {
            extractedData = {};
            dom.statusEl.textContent = 'Upload a file to begin.';
            dom.menuDataTable.innerHTML = '<tr><td colspan="11" class="p-4 text-center text-gray-500">Upload a file to begin.</td></tr>';
            dom.invoiceDataTable.innerHTML = '';
            dom.invoiceNumber.textContent = '';
            dom.invoiceDate.textContent = '';
            dom.invoiceDueDate.textContent = '';
            dom.invoicePayDate.textContent = '';
            dom.invoiceVendor.textContent = '';
            dom.invoiceSubtotal.textContent = '';
            dom.invoiceTax.textContent = '';
            dom.invoiceTotal.textContent = '';
            dom.exportBtn.disabled = true;
            dom.clearListBtn.disabled = true;
            dom.fileInput.value = '';
        }

        async function processWithAI(file) {
            dom.statusEl.textContent = `Analyzing with AI...`;
            if(currentMode === 'menu') {
                dom.menuDataTable.innerHTML = `<tr><td colspan="11" class="p-4 text-center text-gray-500"><div class="loader mx-auto"></div></td></tr>`;
            } else {
                 dom.invoiceDataTable.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500"><div class="loader mx-auto"></div></td></tr>`;
            }

            const base64ImageData = await toBase64(file);
            const mimeType = file.type;
            
            let prompt, schema;
            if (currentMode === 'menu') {
                prompt = "Analyze this document as a restaurant menu. Extract all items into a JSON array. Each object should represent a single menu item or a variant of an item and include these keys: 'cuisineType', 'itemCategory', 'skuCode', 'itemName', 'itemDescription', 'itemPrice', 'variantName', 'variantPrice', 'variantSkuCode'. If a value isn't present, use an empty string. Prices should be numbers.";
                schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            cuisineType: { type: "STRING" },
                            itemCategory: { type: "STRING" },
                            skuCode: { type: "STRING" },
                            itemName: { type: "STRING" },
                            itemDescription: { type: "STRING" },
                            itemPrice: { type: "NUMBER" },
                            variantName: { type: "STRING" },
                            variantPrice: { type: "NUMBER" },
                            variantSkuCode: { type: "STRING" }
                        },
                        required: ["itemName", "itemPrice"]
                    }
                };
            } else { // Invoice mode
                prompt = "Analyze this document as an invoice. Extract the invoice number, date, due date, pay date, vendor name, all line items, subtotal, tax, and grandTotal. For each line item, extract the description, quantity, cost price, unit price, tax code, location, and item barcode. Return as a single JSON object. All price/cost/total fields should be numbers.";
                schema = {
                    type: "OBJECT",
                    properties: {
                        invoiceNumber: { type: "STRING" },
                        date: { type: "STRING" },
                        dueDate: { type: "STRING" },
                        payDate: { type: "STRING" },
                        vendor: { type: "STRING" },
                        lineItems: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    description: { type: "STRING" },
                                    itemBarcode: { type: "STRING" },
                                    quantity: { type: "NUMBER" },
                                    costPrice: { type: "NUMBER" },
                                    unitPrice: { type: "NUMBER" },
                                    taxCode: { type: "STRING" },
                                    location: { type: "STRING" }
                                }
                            }
                        },
                        subtotal: { type: "NUMBER" },
                        tax: { type: "NUMBER" },
                        grandTotal: { type: "NUMBER" }
                    }
                };
            }

            const payload = {
                contents: [{ parts: [ { text: prompt }, { inline_data: { mime_type: mimeType, data: base64ImageData } } ] }],
                generation_config: { response_mime_type: "application/json", response_schema: schema }
            };

            try {
                const apiKey = ""; // Provided by environment
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                extractedData = JSON.parse(text);
                
                dom.statusEl.textContent = `Extraction complete. Please verify.`;
                if (currentMode === 'menu') {
                    renderMenuTable();
                } else {
                    renderInvoiceView();
                }
                dom.exportBtn.disabled = false;
                dom.clearListBtn.disabled = false;

            } catch (error) {
                handleError('AI analysis failed. Please try again.');
                console.error("AI Error:", error);
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
        
        function handleError(message) {
            dom.statusEl.textContent = message;
            if (currentMode === 'menu') {
                dom.menuDataTable.innerHTML = `<tr><td colspan="11" class="p-4 text-center text-red-500">${message}</td></tr>`;
            } else {
                dom.invoiceDataTable.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-red-500">${message}</td></tr>`;
            }
        }
        
        function renderMenuTable() {
            dom.menuDataTable.innerHTML = '';
            if (!extractedData || extractedData.length === 0) {
                dom.menuDataTable.innerHTML = '<tr><td colspan="11" class="p-4 text-center text-gray-500">No items found.</td></tr>';
                return;
            }
            
            extractedData.forEach((item, index) => {
                const row = document.createElement('tr');
                const itemPrice = parseFloat(item.itemPrice);
                const variantPrice = parseFloat(item.variantPrice);
                row.innerHTML = `
                    <td class="p-2 border-b border-gray-200 text-center"><input type="checkbox"></td>
                    <td class="p-2 border-b border-gray-200 text-center text-sm text-gray-500">${index + 1}</td>
                    <td class="p-2 border-b border-gray-200"><div contenteditable="true">${item.itemName || ''}</div></td>
                    <td class="p-2 border-b border-gray-200"><div contenteditable="true">RM ${!isNaN(itemPrice) ? itemPrice.toFixed(2) : ''}</div></td>
                    <td class="p-2 border-b border-gray-200"><div contenteditable="true">${item.itemCategory || ''}</div></td>
                    <td class="p-2 border-b border-gray-200"><div contenteditable="true">${item.itemDescription || ''}</div></td>
                    <td class="p-2 border-b border-gray-200"><div contenteditable="true">${item.cuisineType || ''}</div></td>
                    <td class="p-2 border-b border-gray-200"><div contenteditable="true">${item.variantName || ''}</div></td>
                    <td class="p-2 border-b border-gray-200"><div contenteditable="true">RM ${!isNaN(variantPrice) ? variantPrice.toFixed(2) : ''}</div></td>
                    <td class="p-2 border-b border-gray-200"><div contenteditable="true">${item.skuCode || ''}</div></td>
                    <td class="p-2 border-b border-gray-200"><div contenteditable="true">${item.variantSkuCode || ''}</div></td>
                `;
                dom.menuDataTable.appendChild(row);
            });
        }

        function renderInvoiceView() {
            dom.invoiceNumber.textContent = extractedData.invoiceNumber || '';
            dom.invoiceDate.textContent = extractedData.date || '';
            dom.invoiceDueDate.textContent = extractedData.dueDate || '';
            dom.invoicePayDate.textContent = extractedData.payDate || '';
            dom.invoiceVendor.textContent = extractedData.vendor || '';

            dom.invoiceDataTable.innerHTML = '';
            if (!extractedData.lineItems || extractedData.lineItems.length === 0) {
                dom.invoiceDataTable.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">No line items found.</td></tr>';
            } else {
                extractedData.lineItems.forEach(item => {
                    const row = document.createElement('tr');
                    const grossAmount = (item.quantity || 0) * (item.unitPrice || 0);
                    row.innerHTML = `
                        <td class="p-2 border-b border-gray-200"><div contenteditable="true">${item.description || ''}</div></td>
                        <td class="p-2 border-b border-gray-200"><div contenteditable="true">${item.itemBarcode || ''}</div></td>
                        <td class="p-2 border-b border-gray-200"><div contenteditable="true">${item.quantity || 1}</div></td>
                        <td class="p-2 border-b border-gray-200"><div contenteditable="true">${(item.costPrice || 0).toFixed(2)}</div></td>
                        <td class="p-2 border-b border-gray-200">${grossAmount.toFixed(2)}</td>
                        <td class="p-2 border-b border-gray-200"><div contenteditable="true">${item.taxCode || ''}</div></td>
                        <td class="p-2 border-b border-gray-200"><div contenteditable="true">${item.location || ''}</div></td>
                    `;
                    dom.invoiceDataTable.appendChild(row);
                });
            }
            
            dom.invoiceSubtotal.textContent = (extractedData.subtotal || 0).toFixed(2);
            dom.invoiceTax.textContent = (extractedData.tax || 0).toFixed(2);
            dom.invoiceTotal.textContent = (extractedData.grandTotal || 0).toFixed(2);
        }

        dom.clearListBtn.addEventListener('click', () => {
            resetUI();
            dom.statusEl.textContent = 'List cleared. Upload a new file.';
        });

        // --- CSV Export ---
        dom.exportBtn.addEventListener('click', () => {
            let csvContent = "data:text/csv;charset=utf-8,";
            if (currentMode === 'menu') {
                const headers = ["#", "Item Name", "Item Price", "Item Category", "Description", "Cuisine Type", "Variant Name", "Variant Price", "SKU Code", "Variant SKU"];
                csvContent += headers.join(',') + "\r\n";
                extractedData.forEach((item, index) => {
                    const rowData = [
                        index + 1,
                        item.itemName || '',
                        item.itemPrice || '',
                        item.itemCategory || '',
                        item.itemDescription || '',
                        item.cuisineType || '',
                        item.variantName || '',
                        item.variantPrice || '',
                        item.skuCode || '',
                        item.variantSkuCode || ''
                    ];
                    const row = rowData.map(d => `"${String(d).replace(/"/g, '""')}"`).join(',');
                    csvContent += row + "\r\n";
                });
            } else {
                csvContent += "Description,Barcode,Quantity,Cost Price,Gross Amount,Tax Code,Location\r\n";
                if(extractedData.lineItems) {
                    extractedData.lineItems.forEach(item => {
                        const grossAmount = (item.quantity || 0) * (item.unitPrice || 0);
                        const row = `"${(item.description || '').replace(/"/g, '""')}",${item.itemBarcode || ''},${item.quantity || 1},${item.costPrice || 0},${grossAmount},${item.taxCode || ''},"${(item.location || '').replace(/"/g, '""')}"`;
                        csvContent += row + "\r\n";
                    });
                }
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${currentMode}_data.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
    </script>
</body>
</html>
